{"version":3,"sources":["../../../src/config/config.controllers.ts","../../../src/config/config.defaults.ts","../../../src/config/config.schemas.ts","../../../src/modules/build/build.controllers.ts","../../../src/modules/build/build.utilities.ts","../../../src/modules/build/index.ts"],"sourcesContent":["import fs from 'fs-extra';\r\nimport prompts from 'prompts';\r\n\r\nimport { defaultConfig } from './config.defaults.js';\r\nimport { Config, ConfigSchema } from './config.schemas.js';\r\n\r\nconst CONFIG_FILE = 'contract.config.json';\r\n\r\n// Writes the default config to the config file.\r\nconst writeDefaultConfig = async () => fs.writeJson(CONFIG_FILE, defaultConfig, { spaces: 2 });\r\n\r\nasync function askForConfigRewrite(): Promise<boolean> {\r\n  // Prompt the user to confirm if they want to rewrite the config file with default values.\r\n\r\n  const response = await prompts({\r\n    type: 'confirm',\r\n    name: 'rewrite',\r\n    message: 'The config file is invalid, do you want to rewrite it with default values?',\r\n    initial: true,\r\n  });\r\n  return response.rewrite;\r\n}\r\n\r\nexport async function readConfigFile(): Promise<Config> {\r\n  // Check if the config file exists, if not, write the default config.\r\n  if (!(await fs.pathExists(CONFIG_FILE))) {\r\n    await writeDefaultConfig();\r\n  }\r\n\r\n  // Read and validate the config file (with zod).\r\n  const rawContent = await fs.readFile(CONFIG_FILE, 'utf8');\r\n  const parsedContent = ConfigSchema.safeParse(JSON.parse(rawContent));\r\n\r\n  // If the content is invalid, ask the user if they want to\r\n  // rewrite it with default values or throw an error.\r\n  if (!parsedContent.success) {\r\n    if (await askForConfigRewrite()) {\r\n      await writeDefaultConfig();\r\n      return defaultConfig;\r\n    } else throw new Error(`Invalid config file: ${parsedContent.error.message}`);\r\n  }\r\n\r\n  return parsedContent.data;\r\n}\r\n","import { Config } from './config.schemas.js';\n\nexport const defaultConfig: Config = {\n  $schema: 'https://raw.githubusercontent.com/kalutskii/contract/refs/heads/main/static/contract.schema.json',\n  appName: 'your-app',\n  externalSources: [],\n  contracts: [],\n};\n","import z from 'zod';\r\n\r\nexport const ContractSchema = z.object({\r\n  name: z.string(),\r\n  emit: z.boolean().optional(),\r\n});\r\n\r\nexport const ConfigSchema = z.object({\r\n  $schema: z.url(),\r\n  appName: z.string(),\r\n  externalSources: z.array(z.string()),\r\n  contracts: z.array(ContractSchema),\r\n});\r\n\r\nexport type Contract = z.infer<typeof ContractSchema>;\r\nexport type Config = z.infer<typeof ConfigSchema>;\r\n","import path from 'node:path';\r\n\r\nimport { build } from 'esbuild';\r\nimport fs from 'fs-extra';\r\n\r\nimport { Config, Contract } from '../../config/config.schemas.js';\r\nimport { executeCommand } from './build.utilities.js';\r\n\r\nconst CONTRACT_DIR = path.join(process.cwd(), 'contract');\r\n\r\nexport async function bundleRuntimeContract(config: Config, contract: Contract): Promise<void> {\r\n  // This function will handle the bundling of runtime contracts.\r\n  // Currently, it just reads the config file and logs the contracts.\r\n\r\n  const input = path.join(CONTRACT_DIR, 'source', `contract.${contract.name}.source.ts`);\r\n  const output = path.join(CONTRACT_DIR, 'export', `${config.appName}.contract.${contract.name}.ts`);\r\n\r\n  const result = await build({\r\n    entryPoints: [input],\r\n    bundle: true,\r\n    format: 'esm',\r\n    write: false,\r\n    treeShaking: true,\r\n    minifySyntax: true,\r\n    platform: 'node',\r\n    target: 'es2022',\r\n  });\r\n\r\n  const content = result.outputFiles[0].text;\r\n  await fs.writeFile(output, content);\r\n\r\n  console.log(`‚úÖ Runtime contract bundled to ${output}`);\r\n}\r\n\r\nexport async function bundleDeclarationContract(config: Config, contract: Contract): Promise<void> {\r\n  // This function will handle the bundling of contract declarations.\r\n  // Currently, it just reads the config file and logs the contracts.\r\n\r\n  const input = path.join(CONTRACT_DIR, 'source', `contract.${contract.name}.source.ts`);\r\n  const output = path.join(CONTRACT_DIR, 'export', `${config.appName}.contract.${contract.name}.d.ts`);\r\n\r\n  await executeCommand('npx', ['dts-bundle-generator', '-o', output, input, '--no-check']);\r\n}\r\n","import { execa } from 'execa';\r\n\r\nexport async function executeCommand(command: string, args: string[]): Promise<void> {\r\n  // Executes a command using execa and handles errors.\r\n  // If the command fails, it throws an error with the command and its arguments.\r\n\r\n  let stderr = '';\r\n\r\n  const subprocess = execa(command, args, {\r\n    stdio: ['ignore', 'pipe', 'pipe'],\r\n    shell: true,\r\n  });\r\n\r\n  subprocess.stderr?.on('data', (data) => (stderr += data.toString()));\r\n  const { exitCode } = await subprocess;\r\n\r\n  if (exitCode !== 0) {\r\n    throw new Error(`‚ùå Command ${command} ${args.join(' ')} failed:\\n${stderr}`);\r\n  }\r\n}\r\n","import { readConfigFile } from '../../config/config.controllers.js';\r\nimport { Config, Contract } from '../../config/config.schemas.js';\r\nimport { bundleDeclarationContract, bundleRuntimeContract } from './build.controllers.js';\r\n\r\nasync function buildContract(config: Config, contract: Contract): Promise<void> {\r\n  // This function will handle the building of contracts.\r\n  // Currently, it just reads the config file and logs the contracts.\r\n\r\n  console.log('üîó Building contract:', contract.name);\r\n\r\n  if (contract.emit) {\r\n    await bundleRuntimeContract(config, contract);\r\n  } else await bundleDeclarationContract(config, contract);\r\n}\r\n\r\nexport async function runCommand() {\r\n  const config = await readConfigFile();\r\n\r\n  await Promise.all(\r\n    config.contracts.map(async (contract) => {\r\n      await buildContract(config, contract);\r\n    })\r\n  );\r\n}\r\n"],"mappings":"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","names":["fs","fs"]}